name: Helion build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system packages
      run: |
        sudo apt update
        sudo apt install -y python3 python3-dev build-essential git curl cmake xz-utils

    - name: Install uv (recommended by Helion)
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Create uv virtual environment
      run: |
        uv venv .venv

    - name: Bootstrap pip into venv & install build tools
      run: |
        # Use the venv python to ensure installs go into .venv
        source .venv/bin/activate
        # ensure pip present in venv
        python -m ensurepip --upgrade || curl -sS https://bootstrap.pypa.io/get-pip.py | python -
        python -m pip install --upgrade pip setuptools wheel build

    - name: Install PyTorch 2.9+ and Triton 3.5+
      run: |
        source .venv/bin/activate
        python -m pip install --upgrade pip
        # adjust index-url or torch version as needed for your target CUDA / CPU environment
        python -m pip install torch --index-url https://download.pytorch.org/whl/cu124 || true
        python -m pip install triton==3.5.0 || true

    - name: Install Helion (editable) + dev deps
      run: |
        source .venv/bin/activate
        python -m pip install -e .'[dev]' || true

    - name: Install pre-commit + pyrefly
      run: |
        source .venv/bin/activate
        python -m pip install --upgrade pre-commit pyrefly

    - name: Fix Pyrefly search path dynamically (so pyrefly finds site-packages like torch)
      run: |
        PYVER=$(python3 -c "import sys;print(f'{sys.version_info.major}.{sys.version_info.minor}')")
        # if pyproject.toml contains a search-path entry pointing to a non-existing path, replace it
        if grep -q "search-path" pyproject.toml; then
          sed -i "s|search-path = \[.*\]|search-path = [\".venv/lib/python${PYVER}/site-packages\"]|" pyproject.toml || true
        fi

    - name: Install pre-commit hooks
      run: |
        source .venv/bin/activate
        pre-commit install

    - name: Run pre-commit checks
      run: |
        source .venv/bin/activate
        # run linters/typechecks; if you want to skip on CI uncomment the next line.
        pre-commit run --all-files || true

    - name: Build wheel & sdist (python -m build)
      run: |
        source .venv/bin/activate
        python -m pip install --upgrade build
        python -m build

    - name: Package dist + source into tarball
      run: |
        # create artifact tarball containing the built distributions and source
        tar -czf helion-artifact.tar.gz dist/ helion/ pyproject.toml README.md || \
        # fallback: package source only (if build failed)
        tar --exclude='.git' --exclude='.github' -czf helion-source-artifact.tar.gz helion/ pyproject.toml README.md

    - name: Upload artifact to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: helion-artifact
        path: |
          helion-artifact.tar.gz
          helion-source-artifact.tar.gz

    # - name: Upload artifact to Nexus (optional)
    #   if: ${{ secrets.NEXUS_USER && secrets.NEXUS_PASS }}
    #   run: |
    #     # pick the packed artifact (prefer the built one)
    #     ART=helion-artifact.tar.gz
    #     if [ ! -f "$ART" ]; then ART=helion-source-artifact.tar.gz; fi
    #     curl -v -u ${{ secrets.NEXUS_USER }}:${{ secrets.NEXUS_PASS }} \
    #       --upload-file $ART \
    #       https://your-nexus-url/repository/releases/$ART
