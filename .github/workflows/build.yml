name: Helion build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout your fork of Helion
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Install system dependencies
    - name: Install system packages
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip python3-dev build-essential git curl cmake

    # 3. Install uv (Recommended for Helion)
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    # 4. Create UV virtual environment
    - name: Create uv virtual environment
      run: |
        uv venv .venv
        source .venv/bin/activate

    # 5. Install PyTorch 2.9+ and Triton 3.5+
    - name: Install PyTorch + Triton
      run: |
        source .venv/bin/activate
        pip install --upgrade pip
        pip install torch --index-url https://download.pytorch.org/whl/cu124
        pip install triton==3.5.0

    # 6. Install Helion in editable dev mode
    - name: Install Helion (editable)
      run: |
        source .venv/bin/activate
        pip install -e .'[dev]'

    # 7. Install pre-commit hooks
    - name: Install pre-commit
      run: |
        source .venv/bin/activate
        pip install pre-commit
        pip install pyrefly
        pre-commit install

    # 8. Run lint checks (ruff, pyrefly, etc.)
    - name: Run pre-commit checks
      run: |
        source .venv/bin/activate
        pre-commit run --all-files

    # 9. Security scan (Trivy)
    - name: Trivy File System Scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: fs
        scan-ref: .

    # 10. Package the artifact
    - name: Create artifact package
      run: |
        tar -czf helion-artifact.tar.gz .venv/ helion/ setup.py pyproject.toml

    # 11. Upload artifact to GitHub
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: helion-artifact
        path: helion-artifact.tar.gz

    # 12. Upload artifact to Nexus (optional)
    - name: Upload to Nexus
      if: always()
      run: |
        curl -v -u ${{ secrets.NEXUS_USER }}:${{ secrets.NEXUS_PASS }} \
        --upload-file helion-artifact.tar.gz \
        https://your-nexus-url/repository/releases/helion-artifact.tar.gz
